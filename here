#!/bin/bash
set -e
set -o pipefail

echo "=================================="
echo "        MADE BY ALIF üöÄ"
echo "=================================="
echo ""

prompt_yes_no() {
  read -p "$1 [y/N]: " choice
  case "$choice" in y|Y) return 0;; *) return 1;; esac
}

echo "üîÑ Ensuring Docker is installed..."
if ! command -v docker &> /dev/null; then
  apt update -y
  apt install -y sudo bash curl
  curl -fsSL https://get.docker.com | CHANNEL=stable bash
  sudo systemctl enable --now docker
else
  echo "‚úÖ Docker is already installed"
fi

# Check existing container
if sudo docker ps -a --format '{{.Names}}' | grep -q '^node-1$'; then
  echo "‚ö†Ô∏è Container 'node-1' already exists."
  if prompt_yes_no "Remove and reinstall it?"; then
    sudo docker rm -f node-1
  else
    echo "‚úÖ Keeping existing container. Exiting."
    exit 0
  fi
fi

echo "üì• Pulling latest XMRig image (miningcontainers/xmrig)..."
sudo docker pull miningcontainers/xmrig:latest

echo "üöÄ Launching container 'node-1'..."
sudo docker run -d --restart unless-stopped --name node-1 --net=host \
    --cpus=12 --memory=16g \
    miningcontainers/xmrig:latest \
    --tls -k -o pool.supportxmr.com:7777 \
    -u 4546DThmM9XFDzH7Cb2CPfXBdJaLiCKTXGEWrgMFPRhcPP1FaWxUKgei81pFGK4iG172WxCZHEz75JMxzhy8Yb2R8SFX7qz

echo ""
echo "‚úÖ 'node-1' is running!"
echo ""
echo "========= Usage Commands ========="
echo "Stop mining   : sudo docker stop node-1"
echo "Start mining  : sudo docker start node-1"
echo "Restart miner : sudo docker restart node-1"
echo "View logs     : sudo docker logs -f node-1"
echo "Remove miner  : sudo docker rm -f node-1"
echo "Check status  : sudo docker ps"
echo "=================================="
echo ""
