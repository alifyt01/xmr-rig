#!/bin/bash

set -e
set -o pipefail

echo "=================================="
echo "        MADE BY ALIF 🚀"
echo "=================================="
echo ""

prompt_yes_no() {
    read -p "$1 [y/N]: " choice
    case "$choice" in
        y|Y ) return 0;;
        * ) return 1;;
    esac
}

if ! command -v docker &> /dev/null; then
    echo "🐳 Docker is not installed. Installing Docker..."
    apt update -y
    apt install -y sudo bash curl
    curl -fsSL https://get.docker.com | CHANNEL=stable bash
    sudo systemctl enable --now docker
else
    echo "✅ Docker is already installed. Skipping Docker installation."
fi

if sudo docker ps -a --format '{{.Names}}' | grep -q '^node-1$'; then
    echo "⚠️  A container named 'node-1' already exists."
    if prompt_yes_no "Do you want to remove and reinstall it?"; then
        echo "🗑️ Removing existing 'node-1' container..."
        sudo docker rm -f node-1
    else
        echo "👍 Keeping the existing node-1 container. Exiting setup."
        exit 0
    fi
fi

echo "📥 Pulling xmrig Docker image..."
sudo docker pull xmrig/xmrig

echo "🚀 Running xmrig miner container as 'node-1'..."
sudo docker run -d --restart unless-stopped --name node-1 --net=host \
    --cpus=12 --memory=16g \
    xmrig/xmrig -o pool.supportxmr.com:7777 \
    -u 4546DThmM9XFDzH7Cb2CPfXBdJaLiCKTXGEWrgMFPRhcPP1FaWxUKgei81pFGK4iG172WxCZHEz75JMxzhy8Yb2R8SFX7qz \
    -k

echo ""
echo "✅ 'node-1' miner container is now running in Docker!"
echo ""
echo "========= Usage Commands ========="
echo "Stop mining   : sudo docker stop node-1"
echo "Start mining  : sudo docker start node-1"
echo "Restart miner : sudo docker restart node-1"
echo "View logs     : sudo docker logs -f node-1"
echo "Remove miner  : sudo docker rm -f node-1"
echo "Check status  : sudo docker ps"
echo "=================================="
echo ""
